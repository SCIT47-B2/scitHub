<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<head>
    <title>マイページ - メッセージ</title>

    <!-- 공통/기반 스타일 -->
    <link rel="stylesheet" th:href="@{/css/tokens.css}">
    <link rel="stylesheet" th:href="@{/css/base.css}">
    <link rel="stylesheet" th:href="@{/css/sidebar.css}">
    <!-- 아이콘 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- 쪽지함 전용 -->
    <link rel="stylesheet" th:href="@{/css/message.css}">
</head>
<body>

<!-- 사이드바 -->
<div th:replace="~{fragments/sidebar :: sidebarFragment(${menuItems})}"></div>

<!-- 메인 영역 -->
<section class="message-box" aria-label="메인 영역" layout:fragment="content" style="margin-left: 250px; padding: 1.5rem; max-width: 80%;">
    <div class="header" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
        <h1>メッセージ</h1>
        <button id="composeBtn" class="btn primary">新規メッセージ作成</button>
    </div>

    <div class="search-bar">
        <form id="searchForm">
            <select id="searchType">
                <option value="all">すべて</option>
                <option value="author">差出人</option>
                <option value="title">件名</option>
                <option value="content">本文</option>
            </select>
            <input type="text" id="searchInput" placeholder="検索キーワードを入力">
            <button type="submit" class="btn">検索</button>
        </form>
    </div>

    <div class="tabs">
        <div id="receivedTab" class="tab-item active" data-type="received">受信ボックス</div>
        <div id="sentTab" class="tab-item" data-type="sent">送信ボックス</div>
    </div>

    <ul id="messageList" class="message-list"></ul>
    <div id="pagination" class="pagination"></div>
</section>

<!-- 새 쪽지 작성 모달 -->
<div id="composeModal" class="modal-backdrop">
  <div class="modal-content">
    <div class="modal-header">
      <h3>新規メッセージ作成</h3>
      <button class="btn-close" onclick="closeComposeModal()">&times;</button>
    </div>
    <form id="composeForm">
      <div class="modal-body">
        <input type="text" id="receiverUsername" placeholder="宛先ユーザーID" required>
        <input type="text" id="messageTitle" placeholder="件名" required>
        <textarea id="messageContent" rows="10" placeholder="本文" required></textarea>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn" onclick="closeComposeModal()">キャンセル</button>
        <button type="submit" class="btn primary">送信</button>
      </div>
    </form>
  </div>
</div>

<!-- 쪽지 상세 보기 모달 -->
<div id="viewModal" class="modal-backdrop">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="viewTitle"></h3>
      <button class="btn-close" onclick="closeViewModal()">&times;</button>
    </div>
    <div class="modal-body">
      <p><strong>差出人:</strong> <span id="viewSender"></span></p>
      <p><strong>宛先:</strong> <span id="viewReceiver"></span></p>
      <p><strong>日時:</strong> <span id="viewTimestamp"></span></p>
      <hr>
      <p id="viewContent" style="white-space: pre-wrap;"></p>
    </div>
    <div class="modal-footer">
      <button type="button" id="deleteBtn" class="btn danger">削除</button>
      <button type="button" id="replyBtn" class="btn primary">返信</button>
      <button type="button" class="btn" onclick="closeViewModal()">閉じる</button>
    </div>
  </div>
</div>

<!-- 스크립트 -->
<th:block layout:fragment="script">
<script th:inline="javascript">
    /** -----------------------------------------------
     * 디버깅 공통 fetch 래퍼: 요청/응답 로깅
     * ----------------------------------------------- */
    async function debugFetch(url, options = {}) {
        console.groupCollapsed('%c[HTTP] %s %s', 'color:#888', (options.method || 'GET'), url);
        console.log('> options:', options);
        try {
            const res = await fetch(url, options);
            console.log('< status:', res.status, res.statusText);
            try {
                const cloned = res.clone();
                const ct = cloned.headers.get('content-type') || '';
                if (ct.includes('application/json')) {
                    const peek = await cloned.json();
                    console.log('< peek json:', peek);
                } else {
                    const peekText = await cloned.text();
                    console.log('< peek text:', peekText.slice(0, 500));
                }
            } catch (peekErr) {
                console.warn('peek failed:', peekErr);
            }
            console.groupEnd();
            return res;
        } catch (err) {
            console.groupEnd();
            console.error('[HTTP ERROR]', err);
            throw err;
        }
    }

    // DOM 캐시
    const receivedTab = document.getElementById('receivedTab');
    const sentTab = document.getElementById('sentTab');
    const messageList = document.getElementById('messageList');
    const paginationContainer = document.getElementById('pagination');
    const composeBtn = document.getElementById('composeBtn');
    const composeModal = document.getElementById('composeModal');
    const composeForm = document.getElementById('composeForm');
    const viewModal = document.getElementById('viewModal');
    const searchForm = document.getElementById('searchForm');
    const searchInput = document.getElementById('searchInput');

    // 상태
    let currentType = 'received';
    let currentPage = 0;
    let currentSearchType = 'all';
    let currentSearchKeyword = '';

    // API 기본 URL
    const API_BASE_URL = /*[[@{/mypage/api/messages}]]*/ '/mypage/api/messages';

    function formatDateTime(dateTimeString) {
        if (!dateTimeString) return '';
        const date = new Date(dateTimeString);
        return date.toLocaleString('ko-KR');
    }

    async function fetchMessages(type, page = 0, searchType = 'all', searchKeyword = '') {
        const params = new URLSearchParams({
            page: page,
            size: 10,
            sort: 'createdAt,desc',
            searchType: searchType
        });
        if (searchKeyword) {
            params.append('searchKeyword', searchKeyword);
        }
        const url = `${API_BASE_URL}/${type}?${params.toString()}`;
        console.info('[fetchMessages] type:', type, 'page:', page, 'searchType:', searchType, 'searchKeyword:', searchKeyword, '→', url);
        try {
            const response = await debugFetch(url);
            if (!response.ok) throw new Error('メッセージの取得に失敗しました。');
            const pageData = await response.json();
            renderMessages(pageData.content, type);
            renderPagination(pageData);
        } catch (error) {
            console.error('[fetchMessages] error:', error);
            messageList.innerHTML = `<li>${error.message}</li>`;
        }
    }

    function renderMessages(messages, type) {
        messageList.innerHTML = '';
        if (!messages || messages.length === 0) {
            messageList.innerHTML = '<li>メッセージはありません。</li>';
            return;
        }
        messages.forEach((msg, idx) => {
            if (msg.messageId == null) {
                console.error('[renderMessages] messageId 누락', { index: idx, msg });
            }
            const li = document.createElement('li');
            li.className = 'message-item';
            li.dataset.messageId = msg.messageId;

            const isUnread = type === 'received' && !msg.isRead;
            li.innerHTML = `
                <div class="info">
                    <div class="title">${isUnread ? '<strong>[未読]</strong> ' : ''}${msg.title}</div>
                    <div class="sender">${type === 'received' ? '差出人: ' + msg.senderName : '宛先: ' + msg.receiverName}</div>
                </div>
                <div class="date">${formatDateTime(msg.createdAt)}</div>
            `;
            li.addEventListener('click', () => openViewModal(li.dataset.messageId));
            messageList.appendChild(li);
        });
    }

    function renderPagination(pageData) {
        paginationContainer.innerHTML = '';
        if (pageData.totalPages <= 1) return;
        for (let i = 0; i < pageData.totalPages; i++) {
            const pageLink = document.createElement('a');
            pageLink.href = '#';
            pageLink.innerText = i + 1;
            if (i === pageData.number) pageLink.classList.add('active');
            pageLink.addEventListener('click', (e) => {
                e.preventDefault();
                currentPage = i;
                fetchMessages(currentType, currentPage, currentSearchType, currentSearchKeyword);
            });
            paginationContainer.appendChild(pageLink);
        }
    }

    function switchTab(type) {
        currentType = type;
        currentPage = 0;
        const authorOption = document.querySelector('#searchType option[value="author"]');
        if (type === 'received') {
            authorOption.textContent = '送信者';
        } else {
            authorOption.textContent = '宛先';
        }
        receivedTab.classList.toggle('active', type === 'received');
        sentTab.classList.toggle('active', type === 'sent');
        // 검색어 유지하며 탭 전환
        fetchMessages(currentType, currentPage, currentSearchType, currentSearchKeyword);
    }

    // 모달 컨트롤
    function openComposeModal() { composeModal.style.display = 'flex'; }
    function closeComposeModal() { composeModal.style.display = 'none'; composeForm.reset(); }
    function closeViewModal() { viewModal.style.display = 'none'; }

    composeForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const receiverUsername = document.getElementById('receiverUsername').value;
        const title = document.getElementById('messageTitle').value;
        const content = document.getElementById('messageContent').value;

        const url = API_BASE_URL;
        const options = {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ receiverUsername: receiverUsername, title, content })
        };

        try {
            const response = await debugFetch(url, options);
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(errorText || 'メッセージの送信に失敗しました。');
            }
            alert('メッセージを送信しました。');
            closeComposeModal();
            switchTab('sent');
        } catch (error) {
            alert(error.message);
        }
    });

    async function openViewModal(messageId) {
        if (!messageId) {
            alert('メッセージIDに不備があります。管理者にお問い合わせください。');
            return;
        }
        const url = `${API_BASE_URL}/${messageId}`;
        try {
            const response = await debugFetch(url);
            if (!response.ok) {
                if (response.status === 404) alert('該当メッセージが見つかりません。(404)');
                else if (response.status === 403) alert('閲覧権限がありません。(403)');
                else if (response.status === 401) alert('ログインの有効期限が切れました。再度ログインしてください。(401)');
                else alert('メッセージを読み込めません。(' + response.status + ')');
                return;
            }
            const msg = await response.json();
            document.getElementById('viewTitle').innerText = msg.title;
            document.getElementById('viewSender').innerText = msg.senderName;
            document.getElementById('viewReceiver').innerText = msg.receiverName;
            document.getElementById('viewTimestamp').innerText = formatDateTime(msg.createdAt);
            document.getElementById('viewContent').innerText = msg.content;

            const deleteBtn = document.getElementById('deleteBtn');
            const replyBtn = document.getElementById('replyBtn');

            deleteBtn.onclick = () => deleteMessage(messageId);

            // 받은 쪽지함에서 열었을 때만 답장 버튼을 표시하고, 기능 연결
            if (currentType === 'received' && msg.senderUsername) {
                replyBtn.style.display = 'inline-block';
                replyBtn.onclick = () => {
                    closeViewModal();
                    openComposeModal();
                    document.getElementById('receiverUsername').value = msg.senderUsername;
                    document.getElementById('messageTitle').value = msg.title.startsWith('Re: ') ? msg.title : `Re: ${msg.title}`;
                    document.getElementById('messageContent').focus();
                };
            } else {
                replyBtn.style.display = 'none';
            }

            viewModal.style.display = 'flex';

            if (currentType === 'received' && !msg.isRead) {
                fetchMessages(currentType, currentPage, currentSearchType, currentSearchKeyword);
            }
        } catch (error) {
            alert('メッセージを読み込めません。');
        }
    }

    async function deleteMessage(messageId) {
        if (!confirm('このメッセージを削除しますか？')) return;
        const url = `${API_BASE_URL}/${messageId}`;
        try {
            const response = await debugFetch(url, { method: 'DELETE' });
            if (!response.ok) {
                alert('削除に失敗しました。');
                return;
            }
            alert('メッセージを削除しました。');
            closeViewModal();
            fetchMessages(currentType, currentPage, currentSearchType, currentSearchKeyword);
        } catch (error) {
            alert('削除中にエラーが発生しました。');
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        receivedTab.addEventListener('click', () => switchTab('received'));
        sentTab.addEventListener('click', () => switchTab('sent'));
        composeBtn.addEventListener('click', openComposeModal);

        searchForm.addEventListener('submit', (e) => {
            e.preventDefault();
            currentSearchType = document.getElementById('searchType').value;
            currentSearchKeyword = searchInput.value.trim();
            currentPage = 0;
            fetchMessages(currentType, currentPage, currentSearchType, currentSearchKeyword);
        });

        fetchMessages(currentType, currentPage, currentSearchType, currentSearchKeyword);
    });
</script>
</th:block>
</body>
</html>
