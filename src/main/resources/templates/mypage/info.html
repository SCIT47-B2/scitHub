<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
  <head>
    <title>マイページ</title>
    <th:block layout:fragment="css">
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
      <link rel="stylesheet" th:href="@{/css/tokens.css}">
      <link rel="stylesheet" th:href="@{/css/base.css}">
      <link rel="stylesheet" th:href="@{/css/sidebar.css}">
      <link rel="stylesheet" th:href="@{/css/mypage.css}">
    </th:block>
    
  </head>
  <body>
    <!-- 좌측: 사이드바 -->
    <div th:replace="~{fragments/sidebar :: sidebarFragment(${menuItems})}"></div>

    <!-- 우측: 콘텐츠 -->
    <main class="profilePage" aria-label="메인 영역" layout:fragment="content">
      <!-- /** 단일 폼
           * @desc   좌측(아바타 업로드) + 우측(정보 입력) 한 번에 저장
           * @action /mypage/info  (POST, multipart/form-data)
           * @return 서버에서 DB 업데이트 후 redirect:/mypage/info
           */ -->
      <form id="profileForm"
            class="profileGrid oneForm"
            th:object="${user}"
            th:action="@{/mypage/info}"
            method="post"
            enctype="multipart/form-data">

        <!-- 좌측: 아바타 + 표시용 정보 -->
        <section class="profileLeft" aria-label="프로필 요약">
          <div class="avatar" id="avatarBox" aria-label="프로필 이미지" role="img">
            <!-- 이미지만 감싸는 내부 래퍼: 프레임 안에 정확히 클리핑 -->
            <div class="avatarClip">
              <img id="avatarImg"
                   th:src="${#strings.isEmpty(user.avatarUrl)} ? @{/images/chiikawaPuzzle.png} : @{/uploads/avatar/{f}(f=${user.avatarUrl})}"
                   alt="프로필 이미지">
            </div>

            <button class="editAvatarBtn" id="editAvatarBtn" title="プロフィール画像を変更" type="button">
              <i class="fa-solid fa-pen" aria-hidden="true"></i>
              <span class="sr-only">프로필 이미지 변경</span>
            </button>
            <!-- 실제 파일 입력(숨김). 컨트롤러에서 @RequestParam("avatar")로 받으세요 -->
            <input id="avatar" name="avatar" type="file" accept="image/*" hidden>
          </div>

          <div class="nameBlock">
            <p id="displayName" class="displayName" th:text="${user.name}">홍길동</p>
            <p id="displayId" class="handle" th:text="${'@' + user.userName}">@userid</p>
          </div>

          <div class="miniBadges">
            <span id="badgeCourse" class="pill">Smart Cloud IT Master</span>
          </div>
          <div class="miniBadges">
            <span id="badgeCohort" class="pill" th:text="${user.cohortNo + '期 ソウル'}">47期 ソウル</span>
          </div>
        </section>

        <!-- 우측: 입력 필드 -->
        <section id="profileWrap" class="profileWrap readonly" aria-label="프로필 입력">
          <div class="profileRight">
            <div class="formRow">
              <label for="name">名前</label>
              <div class="field">
                <input id="name" name="name" type="text" placeholder="名前" th:field="*{name}">
              </div>
            </div>

            <div class="formRow" role="radiogroup" aria-label="성별">
              <label>性別</label>
              <div class="radioGroup">
                <label class="radioItem">
                  <input type="radio" th:field="*{gender}" name="gender" value="M"> <span>男</span>
                </label>
                <label class="radioItem">
                  <input type="radio" th:field="*{gender}" name="gender" value="F"> <span>女</span>
                </label>
                <label class="radioItem">
                  <input type="radio" th:field="*{gender}" value="N"> <span>選択しない</span>
                </label>
              </div>
            </div>

            <div class="formRow">
              <label for="email">メールアドレス</label>
              <div class="field">
                <input id="email" name="email" type="email" placeholder="name@example.com" th:field="*{email}">
              </div>
            </div>

            <div class="formRow">
              <label for="birth">生年月日</label>
              <div class="field">
                <input id="birth" name="birth" type="date"
                      th:value="${#temporals.format(user.birth, 'yyyy-MM-dd')}"
                      th:attr="max=${#temporals.format(#temporals.createNow(), 'yyyy-MM-dd')}">
              </div>
            </div>

            <div class="formRow">
              <label for="phone">電話番号</label>
              <div class="field">
                <input id="phone" name="phone" type="tel" placeholder="010-0000-0000" th:field="*{phone}">
              </div>
            </div>

            <div class="actionRow">
              <button type="button" id="cancelBtn" class="btn" th:onclick="|location.href='@{/mypage/info}'|">キャンセル</button>
              <button type="submit" id="saveBtn" class="btn primary">変更を保存</button>
            </div>
          </div>
        </section>
      </form>
      <!-- 단일 폼 끝 -->
    </main>

    <th:block layout:fragment="script">
      <script>
        /**
         * initAvatarPicker
         * @desc   펜 버튼 클릭 → 파일 선택 → 미리보기 표시
         * @param  없음
         * @return void (화면 미리보기만 갱신)
         */
        (function initAvatarPicker(){
          const editAvatarBtn = document.getElementById('editAvatarBtn');
          const avatarInput   = document.getElementById('avatar');
          const avatarImg     = document.getElementById('avatarImg');
          if (!editAvatarBtn || !avatarInput || !avatarImg) return;

          editAvatarBtn.addEventListener('click', function openPicker(){
            avatarInput.click();
          });

          avatarInput.addEventListener('change', function preview(){
            const file = avatarInput.files && avatarInput.files[0];
            if (!file) return;

            // 간단한 클라이언트 검증(서버에서도 반드시 검증)
            if (!file.type.startsWith('image/')) {
              alert('画像ファイルのみアップロードできます。');
              avatarInput.value = '';
              return;
            }
            if (file.size > 10 * 1024 * 1024) {
              alert('ファイルサイズが10MBを超えています。');
              avatarInput.value = '';
              return;
            }

            const reader = new FileReader();
            reader.onload = () => { avatarImg.src = reader.result; };
            reader.readAsDataURL(file);
          });
        })();

        /**
         * validation
         * @desc   필수 입력값 검증 후 통과 시 제출
         * @param  e {SubmitEvent}
         * @return void
         */
        document.getElementById('profileForm').addEventListener('submit', function validation(e){
          e.preventDefault();

          const name   = document.getElementById('name').value.trim();
          const gender = (document.querySelector('input[name="gender"]:checked') || {}).value || '';
          const birth  = document.getElementById('birth').value;
          const email  = document.getElementById('email').value.trim();
          const phone  = document.getElementById('phone').value.trim();

          let message = '';
          if (!name || !gender || !birth || !email || !phone) {
            message = '必須項目をすべて入力してください。';
          } else if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
            message = 'メールアドレスの形式が正しくありません。';
          } else if (!/^\d{2,4}-?\d{3,4}-?\d{4}$/.test(phone)) {
            message = '電話番号の形式が正しくありません。';
          }

          if (message) {
            alert(message);
            if (!name)      return document.getElementById('name')?.focus();
            if (!gender)    return document.querySelector('input[name="gender"]')?.focus();
            if (!birth)     return document.getElementById('birth')?.focus();
            if (!email)     return document.getElementById('email')?.focus();
            if (!phone)     return document.getElementById('phone')?.focus();
            return;
          }

          alert('保存しました。');
          e.target.submit();
        });
      </script>
    </th:block>
  </body>
</html>
