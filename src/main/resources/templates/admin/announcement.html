<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
    xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{layouts/defaultLayout}">
    <head>
        <title>Announcement</title>
        <th:block layout:fragment="css">
            <!-- 이 페이지에만 적용될 CSS 파일을 여기에 추가합니다 -->
            <link rel="stylesheet" th:href="@{/css/announcement.css}">
        </th:block>
    </head>
    <body>
        <!--// layout:fragment="content" : 이 부분이 메인 콘텐츠 영역이 됩니다. //-->
        <section class="mainGrid" layout:fragment="content">

            <!-- 전체 콘텐츠를 감싸는 컨테이너 -->
            <div class="content-container">

                <!-- 왼쪽 메인 콘텐츠 (검색 + 전체 공지 테이블) -->
                <div class="main-content">
                    <!-- 1. 검색 영역 -->
                    <div class="search-bar">
                        <form id="pagingForm" method="get" th:action="@{/admin/announcement}">
                            <input type="hidden" name="page" id="page">
                            <input type="hidden" name="boardName" id="boardName" th:value="${boardName}">
                            <select id="type" name="searchType">
                                <option value="all"     th:selected="${searchType == 'all'}">全て</option>
                                <option value="title"   th:selected="${searchType == 'title'}">タイトル</option>
                                <option value="content" th:selected="${searchType == 'content'}">内容</option>
                                <option value="user"    th:selected="${searchType == 'user'}">投稿者</option>
                            </select>
                            <input type="text" name="searchWord" th:value="${searchWord}" placeholder="検索キーワードを入力してください"/>
                            <button type="button" onclick="pagingFormSubmit(1)"><i class="fa-solid fa-magnifying-glass"></i></button>
                        </form>
                    </div>

                    <!-- 2. 중심 공지 테이블 영역 -->
                    <div class="announcement-section">
                        <div class="section-header">
                            <h2 th:text="${boardName == 'announcement' ? 'お知らせ' : boardName == 'announcementIT' ? 'お知らせ - IT' : 'お知らせ - 日本語'}"></h2>
                            <div class="write-button-container" th:if="${currentUser != null and currentUser.role == 'ROLE_ADMIN'}">
                                <a th:href="@{/admin/announcement/write(boardName=${boardName})}" class="btn-primary">
                                    <i class="fa-solid fa-pencil"></i>
                                    <span>お知らせ作成</span>
                                </a>
                            </div>
                        </div>
                        <table class="announcement-table">
                            <thead>
                                <tr>
                                    <th>番号</th>
                                    <th>タイトル</th>
                                    <th>投稿者</th>
                                    <th>投稿日</th>
                                    <th>閲覧数</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="5" th:if="${postPage.isEmpty()}" class="no-data">お知らせがありません。</td>
                                </tr>
                                <tr th:each="post, status : ${postPage}" th:unless="${postPage.isEmpty()}">
                                    <td th:text="${post.postId}"></td>
                                    <td>
                                        <a th:text="${post.title}" th:href="@{/admin/announcement/read(postId=${post.postId})}"></a>
                                    </td>
                                    <td th:text="${post.userNameKor}" class="center"></td>
                                    <td th:text="${#temporals.format(post.createdAt, 'yy-MM-dd HH:mm')}"></td>
                                    <td th:text="${post.viewCount}" class="center"></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- 3. 페이지네이션 영역 -->
                    <nav class="pagination-container" th:if="${postPage.totalPages > 0}"
                        th:with="blockSize = ${2 * linkSize + 1},
                                startPage = ${((page - 1) / blockSize) * blockSize + 1},
                                endPage = ${T(java.lang.Math).min(startPage + blockSize - 1, postPage.totalPages)}"
                        >
                        <ul class="leftPagination">
                            <li th:if="${postPage.hasPrevious()}">
                                <a href="javascript:pagingFormSubmit(1)">|&lt;</a>
                            </li>
                            <li th:if="${startPage > 1}">
                                <a th:href="|javascript:pagingFormSubmit(${startPage - 1})|">&lt;</a> <!-- 이전 블록 -->
                            </li>
                        </ul>
                        <ul class="pagination">
                            <li th:each="counter : ${#numbers.sequence(startPage, endPage)}">
                                <b th:if="${counter == page}" th:text="${counter}" class="active"></b>
                                <a th:if="${counter != page}" th:href="|javascript:pagingFormSubmit(${counter})|" th:text="${counter}"></a>
                            </li>
                        </ul>
                        <ul class="rightPagination">
                            <li th:if="${endPage < postPage.totalPages}">
                                <a th:href="|javascript:pagingFormSubmit(${endPage + 1})|">&gt;</a> <!-- 다음 블록 -->
                            </li>
                            <li th:if="${postPage.hasNext()}">
                                <a th:href="|javascript:pagingFormSubmit(${postPage.totalPages})|">&gt;|</a>
                            </li>
                        </ul>
                    </nav>
                </div>

                <!-- 오른쪽 사이드 콘텐츠 (타 공지) -->
                <aside class="side-content">
                    <!-- 4. 위쪽 공지 패널 -->
                    <div class="notice-panel" th:with="UpperBoardName=${boardName == 'announcement' ? 'announcementIT' : 'announcement'}">
                        <a th:href="|javascript:changeBoard('${UpperBoardName}')|" class="panel-header">
                            <h3 th:text="${boardName == 'announcement' ? 'お知らせ - IT' : 'お知らせ'}"></h3>
                            <span>&gt;</span>
                        </a>
                        <ul class="notice-list">
                            <li th:if="${upperPosts.isEmpty()}">お知らせがありません。</li>
                            <li th:each="upperPost : ${upperPosts}">
                                <a th:href="@{/admin/announcementRead(postId=${upperPost.postId})}">
                                    <span class="title" th:text="${upperPost.title}"></span>
                                    <span class="date" th:text="${#temporals.format(upperPost.createdAt, 'yyyy-MM-dd')}"></span>
                                </a>

                            </li>
                        </ul>
                    </div>

                    <!-- 5. 아래쪽 공지 패널 -->
                    <div class="notice-panel" th:with="lowerBoardName=${boardName == 'announcementJP' ? 'announcementIT' : 'announcementJP'}">
                        <a th:href="|javascript:changeBoard('${lowerBoardName}')|" class="panel-header">
                            <h3 th:text="${boardName == 'announcementJP' ? 'お知らせ - IT' : 'お知らせ - 日本語'}"></h3>
                            <span>&gt;</span>
                        </a>
                        <ul class="notice-list">
                            <li th:if="${lowerPosts.isEmpty()}">お知らせがありません。</li>
                            <li th:each="lowerPost : ${lowerPosts}">
                                <a th:href="@{/admin/announcementRead(postId=${lowerPost.postId})}">
                                    <span class="title" th:text="${lowerPost.title}"></span>
                                    <span class="date" th:text="${#temporals.format(lowerPost.createdAt, 'yyyy-MM-dd')}"></span>
                                </a>
                            </li>
                        </ul>
                    </div>
                </aside>
            </div>
        </section>
        <th:block layout:fragment="script">
            <script>
                function changeBoard(boardName) {
                    console.log("Changing to board: " + boardName); // 디버그용 로그
                    document.querySelector("#boardName").value = boardName;
                    document.querySelector("#page").value = 1; // 페이지 초기화
                    document.querySelector("#pagingForm").submit();
                }

                function pagingFormSubmit(pageNum) {
                    document.querySelector("#page").value = pageNum;
                    document.querySelector("#pagingForm").submit();
                }
            </script>
        </th:block>
    </body>
</html>

