<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
    xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{layouts/defaultLayout}">
    <head>
        <title>Manage Users</title>
        <th:block layout:fragment="css">
            <link rel="stylesheet" th:href="@{/css/manageUser.css}">
        </th:block>
    </head>
    <body>
        <section class="mainGrid" layout:fragment="content">
            <div class="search-filter-bar">
                <form id="pagingForm" method="get" th:action="@{/admin/manageUser}">
                    <input type="hidden" name="page" id="page">
                    <select name="searchType">
                        <option value="all" th:selected="${searchType == 'all'}">全て</option>
                        <option value="name" th:selected="${searchType == 'name'}">名前</option>
                        <option value="id" th:selected="${searchType == 'id'}">ID</option>
                    </select>
                    <input type="text" name="searchWord" th:value="${searchWord}" placeholder="検索キーワードを入力してください">

                    <select name="cohortNo">
                        <option value="0">全ての期</option>
                        <option th:each="cohort : ${cohortList}" th:value="${cohort}" th:text="${cohort} + '期'" th:selected="${cohort == cohortNo}"></option>
                    </select>

                    <select name="role">
                        <option value="ALL" th:selected="${role == 'ALL'}">全ての権限</option>
                        <option value="ROLE_ADMIN" th:selected="${role == 'ROLE_ADMIN'}">管理者</option>
                        <option value="ROLE_USER" th:selected="${role == 'ROLE_USER'}">ユーザー</option>
                    </select>

                    <button type="submit" class="btn-search">検索</button>
                </form>
            </div>

            <div class="content-box"
                th:data-toggle-url="@{/admin/manageUser/toggleStatus}"
                th:data-role-url="@{/admin/manageUser/changeRole}">
                <table class="user-table">
                    <thead>
                    <tr>
                        <th>会員番号</th><th>ID</th><th>名前</th><th>期</th>
                        <th>生年月日</th><th>性別</th><th>携帯電話番号</th><th>状態</th><th>権限</th><th>操作</th>
                    </tr>
                    </thead>
                    <tbody>
                        <tr th:if="${userPage.isEmpty()}">
                            <td colspan="10" class="no-data">該当する会員がいません。</td>
                        </tr>
                        <tr th:each="user : ${userPage.content}" th:id="|user-row-${user.userId}|">
                            <td class="user-id" th:text="${user.userId}"></td>
                            <td class="username" th:text="${user.username}"></td>
                            <td class="name-kor" th:text="${user.nameKor}"></td>
                            <td class="cohort-no" th:text="${user.cohortNo}"></td>
                            <td class="birth-date" th:text="${user.birthDate}"></td>
                            <td class="gender" th:text="${user.gender == 'Man' ? '男性' : user.gender == 'Woman' ? '女性' : '指定なし'}"></td>
                            <td class="phone" th:text="${user.phone}"></td>
                            <td class="is-active" th:text="${user.isActive ? 'アクティブ' : '非アクティブ'}"></td>
                            <td class="role" th:text="${user.role}"></td>
                            <td class="actions">
                                <button type="button" class="btn-action btn-role-change" th:data-userid="${user.userId}">権限変更</button>
                                <button type="button" class="btn-action"
                                    th:data-userid="${user.userId}"
                                    th:text="${user.isActive ? '無効化' : '有効化'}"
                                    th:classappend="${user.isActive ? 'btn-deactivate' : 'btn-activate'}"></button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <nav class="pagination-container" th:if="${userPage.totalPages > 1}"
                th:with="blockSize = ${linkSize * 2 + 1},
                        startPage = ${((page - 1) / blockSize) * blockSize + 1},
                        endPage = ${T(java.lang.Math).min(startPage + blockSize - 1, userPage.totalPages)}">

                <ul class="leftPagination">
                    <li th:if="${userPage.hasPrevious()}">
                        <a href="javascript:pagingFormSubmit(1)">|&lt;</a>
                    </li>
                    <li th:if="${startPage > 1}">
                        <a th:href="|javascript:pagingFormSubmit(${startPage - 1})|">&lt;</a>
                    </li>
                </ul>

                <ul class="pagination">
                    <li th:each="counter : ${#numbers.sequence(startPage, endPage)}">
                        <b th:if="${counter == page}" th:text="${counter}" class="active"></b>
                        <a th:if="${counter != page}" th:href="|javascript:pagingFormSubmit(${counter})|" th:text="${counter}"></a>
                    </li>
                </ul>

                <ul class="rightPagination">
                    <li th:if="${endPage < userPage.totalPages}">
                        <a th:href="|javascript:pagingFormSubmit(${endPage + 1})|">&gt;</a>
                    </li>
                    <li th:if="${userPage.hasNext()}">
                        <a th:href="|javascript:pagingFormSubmit(${userPage.totalPages})|">&gt;|</a>
                    </li>
                </ul>
            </nav>
        </section>
        <th:block layout:fragment="script">
            <script th:src="@{/js/jquery-3.7.1.min.js}"></script>
            <script>
                // 페이지네이션 폼 제출 함수
                function pagingFormSubmit(pageNum) {
                    // 1. 숨겨진 page 입력 필드에 클릭된 페이지 번호를 설정합니다.
                    document.getElementById('page').value = pageNum;
                    // 2. id가 'pagingForm'인 폼을 제출합니다.
                    document.getElementById('pagingForm').submit();
                }

                $(document).ready(function() {
                    const container = $('.content-box');

                    // 권한 변경 버튼 클릭 이벤트
                    container.on('click', '.btn-role-change', function() {
                        const userId = $(this).data('userid');
                        if (confirm(`会員番号${userId}の権限を変更しますか？`)) {
                            changeUserRole(userId);
                        }
                    });

                    // 상태 변경 버튼 클릭 이벤트 (활성화/비활성화)
                    container.on('click', '.btn-activate, .btn-deactivate', function() {
                        const userId = $(this).data('userid');
                        const actionText = $(this).text();
                        if (confirm(`会員番号${userId}を${actionText}しますか？`)) {
                            toggleUserStatus(userId);
                        }
                    });
                });

                // 사용자 상태 변경 AJAX 함수
                function toggleUserStatus(userId) {
                    const url = $('.content-box').data('toggle-url');

                    $.ajax({
                        url: url,
                        type: 'POST',
                        data: { userId: userId },
                        success: function(updatedUser) {
                            updateTableRow(updatedUser); // ✨ 성공 시 테이블 행 업데이트
                        },
                        error: (xhr) => alert('状態変更に失敗しました: ' + xhr.responseText)
                    });
                }

                // 사용자 권한 변경 AJAX 함수
                function changeUserRole(userId) {
                    const url = $('.content-box').data('role-url');

                    $.ajax({
                        url: url,
                        type: 'POST',
                        data: { userId: userId },
                        success: function(updatedUser) {
                            updateTableRow(updatedUser); // ✨ 성공 시 테이블 행 업데이트
                        },
                        error: (xhr) => alert('権限変更に失敗しました: ' + xhr.responseText)
                    });
                }

                // ✨ 테이블 행(Row)의 내용을 업데이트하는 공통 함수
                function updateTableRow(user) {
                    const row = $(`#user-row-${user.userId}`);
                    if (row.length) {
                        // 각 셀(td)의 내용 업데이트
                        row.find('.is-active').text(user.isActive ? 'アクティブ' : '非アクティブ');
                        row.find('.role').text(user.role);

                        // 상태 변경 버튼 업데이트
                        const statusButton = row.find('.btn-activate, .btn-deactivate');
                        if (user.isActive) {
                            statusButton.text('無効化').removeClass('btn-activate').addClass('btn-deactivate');
                        } else {
                            statusButton.text('有効化').removeClass('btn-deactivate').addClass('btn-activate');
                        }
                    }
                }
            </script>
        </th:block>
    </body>
</html>