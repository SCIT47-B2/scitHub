<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SCIT Hub - Landing</title>
  <link rel="stylesheet" th:href="@{/css/landing.css}" href="/css/landing.css">
  <!-- flatpickr (JavaScript Date Picker) 라이브러리 추가 -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://npmcdn.com/flatpickr/dist/l10n/ja.js"></script>
</head>
<body>
  <div class="mainContainer">
    <section class="leftSection" aria-label="브랜딩">
      <h1 class="logo brandFont">SCIT Hub</h1>
      <p class="description">
        SCIT 専用のスケジュール・情報・コミュニティプラットフォーム
        <br/>SCIT学習と交流のための統合ハブです。
      </p>
    </section>

    <section class="rightSection" aria-label="인증">
      <div class="authButtons">
        <button class="authBtn loginBtn" id="loginBtn" type="button" aria-controls="loginForm" aria-expanded="false">
          Login
          <img th:src="@{/icons/select_arrow.png}" src="/icons/select_arrow.png" alt="" class="btnIcon" id="loginArrow" aria-hidden="true">
        </button>

        <button class="authBtn signupBtn" id="signupBtn" type="button" aria-controls="signupForm" aria-expanded="false">
          Sign up
          <img th:src="@{/icons/select_arrow.png}" src="/icons/select_arrow.png" alt="" class="btnIcon" id="signArrow" aria-hidden="true">
        </button>
      </div>

      <!-- 로그인 폼 -->
      <form class="loginForm" id="loginForm" method="post" th:action="@{/user/login}" action="/user/login" aria-hidden="true">
        <div class="formGroup">
          <input type="text" class="formInput" placeholder="ID" id="username" name="username" autocomplete="username" required>
        </div>
        <div class="formGroup" id="loginPwGroup">
          <input type="password" class="formInput" placeholder="パスワード" id="password" name="password" autocomplete="current-password" required>
        </div>
        <div class="formGroup">
          <button type="submit" class="loginSubmitBtn">ログイン</button>
        </div>
      </form>

      <!-- 회원가입 폼(2단계) -->
      <form class="signupForm" id="signupForm" method="post" th:action="@{/user/signup}" action="/user/signup" aria-hidden="true">
        <div class="signupSteps">
          <!-- 1단계 -->
          <div class="step step-1 show" id="signupStep1">
            <div class="formGroup">
              <select id="classSelect" name="cohortNo" aria-label="기수 선택" required></select>
            </div>

            <div class="formGroup">
              <div class="inputWithBtn">
                <!-- ■ ID: 공백/엔터 금지 + 영문/숫자 모두 포함(3~10자) -->
                <input type="text" class="formInput" placeholder="ID" id="id" name="userName" autocomplete="username" required aria-describedby="idError">
                <button type="button" class="checkBtn" id="idCheckBtn" th:data-url="@{/user/idCheck}" data-url="/user/idCheck">IDチェック</button>
              </div>
              <!-- 중복확인 상태 -->
              <input type="hidden" id="idChecked" name="idChecked" value="false">
              <input type="hidden" id="checkedId" name="checkedId" value="">
              <!-- ■ ID 오류/안내 메시지 표시 영역 -->
              <p id="idError" class="form-message" role="alert" aria-live="polite"></p>
            </div>

            <div class="formGroup" id="signupPwGroup">
              <!-- ■ PW: 공백/엔터 금지 + 8~20자, 영문/숫자/특수문자 각 1개 이상 -->
              <input type="password" class="formInput" placeholder="パスワード" id="pw" name="signupPassword" autocomplete="new-password" required aria-describedby="pwError">
              <!-- ■ PW 오류/안내 메시지 표시 영역 -->
              <p id="pwError" class="form-message" role="alert" aria-live="polite"></p>
            </div>
            <div class="formGroup" id="signupPwCheckGroup">
              <input type="password" class="formInput" placeholder="パスワードの再入力" id="pwcheck" name="passwordConfirm" autocomplete="new-password" required>
            </div>
            <div class="formGroup">
              <button type="button" class="loginSubmitBtn" id="signupNextBtn">次へ</button>
            </div>
          </div>

          <!-- 2단계 -->
          <div class="step step-2" id="signupStep2">
            <div class="formGroup">
              <input type="text" class="formInput" placeholder="名前" id="name" name="name" required>
            </div>
            <div class="formGroup">
              <div class="genderGroup" role="radiogroup" aria-label="성별">
                <label class="radioPill">
                  <input type="radio" name="gender" value="M" required><span>男</span>
                </label>
                <label class="radioPill">
                  <input type="radio" name="gender" value="F" required><span>女</span>
                </label>
                <!-- <label class="radioPill">
                  <input type="radio" name="gender" value="N" required><span class="nonAddPadding">回答しない</span>
                </label> -->
              </div>
            </div>
            <div class="formGroup">
              <input type="text" class="formInput" id="birth" name="birth" placeholder="生年月日" required>
            </div>
            <div class="formGroup">
              <input type="email" class="formInput" placeholder="メールアドレス" id="email" name="email" autocomplete="email" required>
            </div>
            <div class="formGroup">
              <input type="tel" class="formInput" placeholder="電話番号" id="phone" name="phone" required>
            </div>
            <div class="formGroup">
              <button type="submit" class="loginSubmitBtn">会員登録</button>
            </div>
          </div>
        </div>
      </form>
    </section>
  </div>

  <script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function(){
      /** 요소 캐시 */
      const loginBtn = document.getElementById('loginBtn');
      const signupBtn = document.getElementById('signupBtn');
      const loginForm = document.getElementById('loginForm');
      const signupForm = document.getElementById('signupForm');
      const loginArrow = document.getElementById('loginArrow');
      const signArrow  = document.getElementById('signArrow');
      const classSelect = document.getElementById('classSelect');
      const step1 = document.getElementById('signupStep1');
      const step2 = document.getElementById('signupStep2');
      const signupNextBtn = document.getElementById('signupNextBtn');
      const phoneInput = document.getElementById('phone');

      // ■ 에러 요소
      const idInput = document.getElementById('id');
      const pwInput = document.getElementById('pw');
      const pwCheckInput = document.getElementById('pwcheck');
      const idErrorEl = document.getElementById('idError');
      const pwErrorEl = document.getElementById('pwError');

      const ID_INFO_MESSAGE = 'ID: 3〜10文字の英数字<br>（英字必須、空白なし）';
      const PW_INFO_MESSAGE = 'PW: 8〜20文字 (英字、数字、記号を含む)';

      /** ID 필드 메시지 표시 유틸 */
      function displayIdMessage(message, isError) {
        if (!idErrorEl) return;
        idErrorEl.innerHTML = message;
        if (isError) {
          idErrorEl.classList.add('errorText');
        } else {
          idErrorEl.classList.remove('errorText');
        }
      }

      /** PW 필드 메시지 표시 유틸 */
      function displayPwMessage(message, isError) {
        if (!pwErrorEl) return;
        pwErrorEl.textContent = message;
        if (isError) {
          pwErrorEl.classList.add('errorText');
        } else {
          pwErrorEl.classList.remove('errorText');
        }
      }

      // 초기 ID 안내 문구 설정
      displayIdMessage(ID_INFO_MESSAGE, false);
      // 초기 PW 안내 문구 설정
      displayPwMessage(PW_INFO_MESSAGE, false);

      /** 기수 옵션 1회 생성(1~47, 기본 47) */
      if (classSelect && classSelect.options.length === 0) {
        for (let i = 1; i <= 47; i++) {
          const option = document.createElement('option');
          option.value = i;
          option.textContent = i + '期';
          if (i === 47) option.selected = true;
          classSelect.appendChild(option);
        }
      }

      /** flatpickr 초기화 */
      flatpickr("#birth", {
        dateFormat: "Y-m-d",
        maxDate: "today",
        locale: "ja",
        onReady: function(_, __, instance) { instance.input.placeholder = "生年月日"; },
      });

      /** 전화번호 자동 하이픈 추가 */
      phoneInput?.addEventListener('input', (e) => {
        // 숫자 이외의 문자를 모두 제거하고, 3-4-4 형식으로 그룹화
        const match = e.target.value.replace(/\D/g, '').match(/(\d{0,3})(\d{0,4})(\d{0,4})/);
        if (!match) return;
        e.target.value = !match[2] ? match[1] : `${match[1]}-${match[2]}` + (match[3] ? `-${match[3]}` : '');
      });

      /** 로그인 버튼 토글 */
      loginBtn.addEventListener('click', function() {
        const willShow = !loginForm.classList.contains('show');
        loginForm.classList.toggle('show', willShow);
        loginArrow.classList.toggle('rotated', willShow);
        loginBtn.classList.toggle('active', willShow);
        loginBtn.setAttribute('aria-expanded', String(willShow));
        loginForm.setAttribute('aria-hidden', String(!willShow));

        // 상호 배타
        signupBtn.style.display = willShow ? 'none' : '';
        signupForm.classList.remove('show');
        signArrow.classList.remove('rotated');
        signupBtn.classList.remove('active');
        signupBtn.setAttribute('aria-expanded', 'false');
        signupForm.setAttribute('aria-hidden', 'true');
      });

      /** 회원가입 버튼 토글 */
      signupBtn.addEventListener('click', function() {
        const willShow = !signupForm.classList.contains('show');
        signupForm.classList.toggle('show', willShow);
        signArrow.classList.toggle('rotated', willShow);
        signupBtn.classList.toggle('active', willShow);
        signupBtn.setAttribute('aria-expanded', String(willShow));
        signupForm.setAttribute('aria-hidden', String(!willShow));

        // 상호 배타
        loginBtn.style.display = willShow ? 'none' : '';
        loginForm.classList.remove('show');
        loginArrow.classList.remove('rotated');
        loginBtn.classList.remove('active');
        loginBtn.setAttribute('aria-expanded', 'false');
        loginForm.setAttribute('aria-hidden', 'true');

        if (willShow) {
          step1.classList.add('show');
          step2.classList.remove('show');
        }
      });

      /** 로그인 폼 유효성 */
      function validateLoginForm(){
        const username = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value;
        if (!username) return 'IDを入力してください。';
        if (!password) return 'パスワードを入力してください。';
        if (password.length < 6) return 'パスワードは6文字以上で入力してください。';
        return null;
      }

      /** ■ 입력 중 공백/엔터 제거: ID/PW/재입력 */
      function stripWhitespaceOnInput(e){ 
        const prev = e.target.value;
        e.target.value = prev.replace(/\s+/g,''); 
      }
      function preventEnterKey(e){
        if (e.key === 'Enter'){ e.preventDefault(); return false; }
      }
      idInput.addEventListener('input', stripWhitespaceOnInput);
      pwInput.addEventListener('input', stripWhitespaceOnInput);
      pwCheckInput.addEventListener('input', stripWhitespaceOnInput);
      idInput.addEventListener('keydown', preventEnterKey);
      pwInput.addEventListener('keydown', preventEnterKey);
      pwCheckInput.addEventListener('keydown', preventEnterKey);

      /** ■ 회원가입 1단계 유효성(에러는 붉은 글씨로 필드 하단 표시)
       *  - ID: 3~10자, 영문+숫자 모두 포함, 공백/엔터 금지
       *  - PW: 8~20자, 영문/숫자/특수문자 각 1개 이상, 공백/엔터 금지
       *  - PW = PW확인 일치
       *  - ID 중복확인 완료(checked)
       *  @returns {boolean} 통과 여부
       */
      function validateSignupStep1(){
        const userId   = idInput.value.trim();
        const pw       = pwInput.value;
        const pwcheck  = pwCheckInput.value;

        const idChecked = document.getElementById('idChecked').value === 'true';
        const checkedId = document.getElementById('checkedId').value;

        // 정규식 정의
        const idRegex = /^(?=.*[A-Za-z])[A-Za-z\d]{3,10}$/;
        const pwRegex = /^(?=.*[A-Za-z])(?=.*\d)(?=.*[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?`~])(?!.*\s).{8,20}$/;
        // 초기화
        displayIdMessage(ID_INFO_MESSAGE, false);
        displayPwMessage(PW_INFO_MESSAGE, false);

        let isValid = true;

        // ID 검증
        if (!idRegex.test(userId)){
          displayIdMessage(ID_INFO_MESSAGE, true);
          isValid = false;
        } else if (!idChecked || checkedId !== userId){
          displayIdMessage('IDの重複チェックを完了してください。', true);
          isValid = false;
        }

        // PW 검증: 규칙 위반과 불일치 오류를 명확히 구분합니다.
        if (!pwRegex.test(pw)) {
          // 1. 비밀번호가 규칙을 만족하지 못하는 경우, 규칙 안내 메시지를 오류로 표시합니다.
          displayPwMessage(PW_INFO_MESSAGE, true);
          isValid = false;
        } else {
          // 2. 비밀번호 규칙은 통과했을 때, 확인용 비밀번호와 일치하는지 확인합니다.
          if (pw !== pwcheck) {
            displayPwMessage('パスワードが一致しません。', true);
            isValid = false;
          }
        }

        return isValid;
      }

      /** 회원가입 2단계 유효성 (기존 로직 유지) */
      function validateSignupFinal(){
        const name   = document.getElementById('name').value.trim();
        const gender = (document.querySelector('input[name="gender"]:checked') || {}).value || '';
        const birth  = document.getElementById('birth').value;
        const email  = document.getElementById('email').value.trim();
        const phone  = document.getElementById('phone').value.trim();

        if (!name || !gender || !birth || !email || !phone) return '必須項目をすべて入力してください。';
        if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) return 'メールアドレスを正しく入力してください。';
        if (!/^\d{3}-\d{4}-\d{4}$/.test(phone)) return '電話番号は「000-0000-0000」の形式で入力してください。';
        return null;
      }

      /** 1단계 → 2단계 전환 */
      signupNextBtn?.addEventListener('click', function(){
        const ok = validateSignupStep1();
        if (!ok) return;                 // ■ 조건 미충족 시 진행 중단(경고창 대신 붉은 글씨 노출)
        step1.classList.remove('show');
        step2.classList.add('show');
      });

      /** 로그인 제출 */
      loginForm.addEventListener('submit', function(e) {
        const err = validateLoginForm();
        if (err) { e.preventDefault(); alert(err); }
      });

      /** 회원가입 제출 */
      signupForm.addEventListener('submit', function(e) {
        // 1단계 조건 재검증(직접 2단계로 와서 제출하는 경우 대비)
        const ok = validateSignupStep1();
        if (!ok) {
          e.preventDefault();
          step2.classList.remove('show');
          step1.classList.add('show');
          return;
        }
        const finalErr = validateSignupFinal();
        if (finalErr) { e.preventDefault(); alert(finalErr); }
      });

      /** ID 중복확인 버튼: 형식 먼저 통과해야 팝업 오픈 */
      document.querySelector('#idCheckBtn')?.addEventListener('click', function(){
        const baseUrl = this.dataset.url || '/user/idCheck';
        const userId  = idInput.value.trim();

        // 형식 사전 검증
        const idRegex = /^(?=.*[A-Za-z])[A-Za-z\d]{3,10}$/;
        displayIdMessage(ID_INFO_MESSAGE, false);
        if (!idRegex.test(userId)){
          displayIdMessage(ID_INFO_MESSAGE, true);
          idInput.focus();
          return;
        }

        const url = `${baseUrl}?searchId=${encodeURIComponent(userId)}`;
        window.open(url, 'idwin', 'top=200,left=600,width=380,height=320');
      });

      /** ID 입력 변경 시 중복확인 상태 무효화 */
      idInput?.addEventListener('input', function(){
        document.getElementById('idChecked').value = 'false';
        document.getElementById('checkedId').value = '';
        // 사용자가 다시 입력하는 동안, 에러를 숨기고 안내 문구 표시
        displayIdMessage(ID_INFO_MESSAGE, false);
      });

      /** PW/PW확인 입력 중 에러 숨김 */
      pwInput?.addEventListener('input', function(){ displayPwMessage(PW_INFO_MESSAGE, false); });
      pwCheckInput?.addEventListener('input', function(){ displayPwMessage(PW_INFO_MESSAGE, false); });

      /* 회원가입 성공 메시지 처리 */
      const signupMessage = /*[[${signupMessage}]]*/ null;
      if (signupMessage) {
        alert(signupMessage);
        if (window.history.replaceState) {
          const cleanUrl = window.location.protocol + "//" + window.location.host + window.location.pathname;
          window.history.replaceState({ path: cleanUrl }, '', cleanUrl);
        }
      }

      /* 로그인 실패 메시지 처리(기존 유지) */
      const errorMessage = /*[[${errorMessage}]]*/ null;
      if (errorMessage) {
        alert(errorMessage);
        if (window.history.replaceState) {
          const cleanUrl = window.location.protocol + "//" + window.location.host + window.location.pathname;
          window.history.replaceState({ path: cleanUrl }, '', cleanUrl);
        }
      }
    });
  </script>
</body>
</html>
