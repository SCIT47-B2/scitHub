<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SCIT Hub - Landing</title>
  <!-- /** 외부 CSS 분리
        * @file   /css/landing.css
        * @desc   랜딩 페이지 전용 스타일
        */ -->
  <link rel="stylesheet" th:href="@{/css/landing.css}" href="/css/landing.css">
</head>
<body>
  <!-- /** 메인 래퍼
       * @desc   좌측(브랜딩) / 우측(로그인/회원가입)
       */ -->
  <div class="mainContainer">

    <!-- /** 좌측 브랜딩
         * @desc   로고와 소개 문구
         */ -->
    <section class="leftSection" aria-label="브랜딩">
      <h1 class="logo">SCIT Hub</h1>
      <p class="description">
        SCIT 専用のスケジュール・情報・コミュニティプラットフォーム
        <br/>
        SCIT学習と交流のための統合ハブです。
      </p>
    </section>

    <!-- /** 우측 인증
         * @desc   로그인/회원가입 버튼 + 폼
         */ -->
    <section class="rightSection" aria-label="인증">

      <!-- /** 인증 버튼 스택
           * @desc   버튼 클릭 시 해당 폼 표시, 반대 폼/버튼 비표시
           */ -->
      <div class="authButtons">
        <button class="authBtn loginBtn" id="loginBtn" type="button" aria-controls="loginForm" aria-expanded="false">
          Login
          <!-- /** 아이콘: 외부 SVG 파일
               * @path  /icons/arrow_left_alt.svg
               * @note  회전/슬라이드 애니메이션은 CSS 변수 기반
               */ -->
          <img th:src="@{/icons/arrow_left_alt.svg}" src="/icons/arrow_left_alt.svg" alt="" class="btnIcon" id="loginArrow" aria-hidden="true">
        </button>

        <button class="authBtn signupBtn" id="signupBtn" type="button" aria-controls="signupForm" aria-expanded="false">
          Sign up
          <img th:src="@{/icons/arrow_left_alt.svg}" src="/icons/arrow_left_alt.svg" alt="" class="btnIcon" id="signArrow" aria-hidden="true">
        </button>
      </div>

      <!-- /** 로그인 폼
           * @method POST
           * @action /user/login
           * @return 서버 인증 처리
           */ -->
      <form class="loginForm" id="loginForm" method="post" th:action="@{/user/login}" action="/user/login" aria-hidden="true">
        <div class="formGroup">
          <input type="text" class="formInput" placeholder="ID" id="username" name="username" autocomplete="username" required>
        </div>
        <div class="formGroup" id="loginPwGroup">
          <input type="password" class="formInput" placeholder="パスワード" id="password" name="password" autocomplete="current-password" required>
        </div>
        <div class="formGroup">
          <button type="submit" class="loginSubmitBtn">ログイン</button>
        </div>
      </form>

      <!-- /** 회원가입 폼(2단계)
           * @method POST
           * @action /user/signup
           * @return 계정 생성 요청
           */ -->
      <form class="signupForm" id="signupForm" method="post" th:action="@{/user/signup}" action="/user/signup" aria-hidden="true">
        <div class="signupSteps">
          <!-- /** 1단계: 기수/ID/비밀번호 */
               * @id   signupStep1
               */ -->
          <div class="step step-1 show" id="signupStep1">
            <div class="formGroup">
              <select id="classSelect" name="cohortNo" aria-label="기수 선택" required></select>
            </div>

            <div class="formGroup">
              <div class="inputWithBtn">
                <input type="text" class="formInput" placeholder="ID" id="id" name="userName" autocomplete="username" required>
                <button type="button" class="checkBtn" id="idCheckBtn" th:data-url="@{/user/idCheck}" data-url="/user/idCheck">IDチェック</button>
              </div>
              <!-- /** 중복확인 상태 저장용(hidden)
                   * @field idChecked  : boolean 문자열('true'|'false')
                   * @field checkedId  : 중복확인 시점의 아이디
                   */ -->
              <input type="hidden" id="idChecked" name="idChecked" value="false">
              <input type="hidden" id="checkedId" name="checkedId" value="">
            </div>

            <div class="formGroup" id="signupPwGroup">
              <input type="password" class="formInput" placeholder="パスワード" id="pw" name="signupPassword" autocomplete="new-password" required>
            </div>
            <div class="formGroup" id="signupPwCheckGroup">
              <input type="password" class="formInput" placeholder="パスワードの再入力" id="pwcheck" name="passwordConfirm" autocomplete="new-password" required>
            </div>
            <div class="formGroup">
              <button type="button" class="loginSubmitBtn" id="signupNextBtn">次へ</button>
            </div>
          </div>

          <!-- /** 2단계: 기본 정보 */
               * @id   signupStep2
               */ -->
          <div class="step step-2" id="signupStep2">
            <div class="formGroup">
              <input type="text" class="formInput" placeholder="名前" id="name" name="name" required>
            </div>
            <div class="formGroup">
              <div class="genderGroup" role="radiogroup" aria-label="성별">
                <label class="radioPill">
                  <input type="radio" name="gender" value="M" required><span class="addPadding">男</span>
                </label>
                <label class="radioPill">
                  <input type="radio" name="gender" value="F" required><span class="addPadding">女</span>
                </label>
                <label class="radioPill">
                  <input type="radio" name="gender" value="N" required><span class="nonAddPadding">回答しない</span>
                </label>
              </div>
            </div>
            <div class="formGroup">
              <input type="date" class="formInput" id="birth" name="birth" th:max="${#temporals.format(#temporals.createNow(), 'yyyy-MM-dd')}" required>
            </div>
            <div class="formGroup">
              <input type="email" class="formInput" placeholder="メールアドレス" id="email" name="email" autocomplete="email" required>
            </div>
            <div class="formGroup">
              <input type="tel" class="formInput" placeholder="電話番号" id="phone" name="phone" required>
            </div>
            <div class="formGroup">
              <button type="submit" class="loginSubmitBtn">会員登録</button>
            </div>
          </div>
        </div>
      </form>
    </section>
  </div>

  <!-- /** 인터랙션 스크립트(필수)
       * @desc   버튼 토글, 유효성검증, ID 중복확인 팝업
       */ -->
  <script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function(){
      /** 요소 캐시 */
      const loginBtn = document.getElementById('loginBtn');
      const signupBtn = document.getElementById('signupBtn');
      const loginForm = document.getElementById('loginForm');
      const signupForm = document.getElementById('signupForm');
      const loginArrow = document.getElementById('loginArrow');
      const signArrow  = document.getElementById('signArrow');
      const classSelect = document.getElementById('classSelect');
      const step1 = document.getElementById('signupStep1');
      const step2 = document.getElementById('signupStep2');
      const signupNextBtn = document.getElementById('signupNextBtn');

      /** 기수 옵션 1회 생성(1~47, 기본 47) */
      if (classSelect && classSelect.options.length === 0) {
        for (let i = 1; i <= 47; i++) {
          const option = document.createElement('option');
          option.value = i;
          option.textContent = i + '期';
          if (i === 47) option.selected = true;
          classSelect.appendChild(option);
        }
      }

      /** 로그인 버튼 토글 */
      loginBtn.addEventListener('click', function() {
        const willShow = !loginForm.classList.contains('show');
        loginForm.classList.toggle('show', willShow);
        loginArrow.classList.toggle('rotated', willShow);
        loginBtn.classList.toggle('active', willShow);
        loginBtn.setAttribute('aria-expanded', String(willShow));
        loginForm.setAttribute('aria-hidden', String(!willShow));

        // 상호 배타
        signupBtn.style.display = willShow ? 'none' : '';
        signupForm.classList.remove('show');
        signArrow.classList.remove('rotated');
        signupBtn.classList.remove('active');
        signupBtn.setAttribute('aria-expanded', 'false');
        signupForm.setAttribute('aria-hidden', 'true');
      });

      /** 회원가입 버튼 토글 */
      signupBtn.addEventListener('click', function() {
        const willShow = !signupForm.classList.contains('show');
        signupForm.classList.toggle('show', willShow);
        signArrow.classList.toggle('rotated', willShow);
        signupBtn.classList.toggle('active', willShow);
        signupBtn.setAttribute('aria-expanded', String(willShow));
        signupForm.setAttribute('aria-hidden', String(!willShow));

        // 상호 배타
        loginBtn.style.display = willShow ? 'none' : '';
        loginForm.classList.remove('show');
        loginArrow.classList.remove('rotated');
        loginBtn.classList.remove('active');
        loginBtn.setAttribute('aria-expanded', 'false');
        loginForm.setAttribute('aria-hidden', 'true');

        if (willShow) {
          step1.classList.add('show');
          step2.classList.remove('show');
        }
      });

      /** 로그인 폼 유효성 */
      function validateLoginForm(){
        const username = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value;
        if (!username) return 'IDを入力してください。';
        if (!password) return 'パスワードを入力してください。';
        if (password.length < 6) return 'パスワードは6文字以上で入力してください。';
        return null;
      }

      /** 회원가입 1단계 유효성 + 중복확인 체크 */
      function validateSignupStep1(){
        const userId   = document.getElementById('id').value.trim();
        const pw       = document.getElementById('pw').value;
        const pwcheck  = document.getElementById('pwcheck').value;
        const idChecked = document.getElementById('idChecked').value === 'true';
        const checkedId = document.getElementById('checkedId').value;

        if (!userId || !pw || !pwcheck) return 'IDとパスワードの両方を入力してください。';
        if (pw.length < 6) return 'パスワードは6文字以上で入力してください。';
        if (pw !== pwcheck) return 'パスワードが一致しません。';
        if (!idChecked || checkedId !== userId) return 'IDの重複チェックを完了してください。';
        return null;
      }

      /** 회원가입 2단계 유효성 */
      function validateSignupFinal(){
        const name   = document.getElementById('name').value.trim();
        const gender = (document.querySelector('input[name="gender"]:checked') || {}).value || '';
        const birth  = document.getElementById('birth').value;
        const email  = document.getElementById('email').value.trim();
        const phone  = document.getElementById('phone').value.trim();

        if (!name || !gender || !birth || !email || !phone) return '必須項目をすべて入力してください。';
        if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) return 'メールアドレスを正しく入力してください。';
        if (!/^\d{2,4}-?\d{3,4}-?\d{4}$/.test(phone)) return '電話番号を正しく入力してください。';
        return null;
      }

      /** 1단계 → 2단계 전환 */
      signupNextBtn?.addEventListener('click', function(){
        const err = validateSignupStep1();
        if (err) { alert(err); return; }
        step1.classList.remove('show');
        step2.classList.add('show');
      });

      /** 로그인 제출 */
      loginForm.addEventListener('submit', function(e) {
        const err = validateLoginForm();
        if (err) { e.preventDefault(); alert(err); }
      });

      /** 회원가입 제출 */
      signupForm.addEventListener('submit', function(e) {
        const step1Err = validateSignupStep1();
        if (step1Err) {
          e.preventDefault();
          alert(step1Err);
          step2.classList.remove('show');
          step1.classList.add('show');
          return;
        }
        const finalErr = validateSignupFinal();
        if (finalErr) { e.preventDefault(); alert(finalErr); }
      });

      /** ID 중복확인 팝업 */
      document.querySelector('#idCheckBtn')?.addEventListener('click', function(){
        const baseUrl = this.dataset.url || '/user/idCheck';
        const userId  = document.getElementById('id').value.trim();
        if (userId.length < 3 || userId.length > 11) {
          alert('IDは3〜10文字で入力してください。');
          document.getElementById('id').focus();
          return;
        }
        const url = `${baseUrl}?searchId=${encodeURIComponent(userId)}`;
        window.open(url, 'idwin', 'top=200,left=600,width=300,height=300');
      });

      /** ID 입력 변경 시 중복확인 상태 무효화 */
      document.getElementById('id')?.addEventListener('input', function(){
        document.getElementById('idChecked').value = 'false';
        document.getElementById('checkedId').value = '';
      });

      /* 로그인 실패 메시지 처리 */
      const errorMessage = /*[[${errorMessage}]]*/ null;
      if (errorMessage) {
          alert(errorMessage);
          // URL에서 에러 파라미터를 제거하여 새로고침 시 alert가 다시 뜨지 않도록 함
          if (window.history.replaceState) {
              const cleanUrl = window.location.protocol + "//" + window.location.host + window.location.pathname;
              window.history.replaceState({ path: cleanUrl }, '', cleanUrl);
          }
      }
    });
  </script>
</body>
</html>
