<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
    xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{layouts/defaultLayout}">
    <head>
        <title>Course Review</title>
        <th:block layout:fragment="css">
            <link rel="stylesheet" th:href="@{/css/archive.css}">
        </th:block>
    </head>
    <body>
        <section class="mainGrid" aria-label="메인 영역" layout:fragment="content">
            <div class="container">
                <!-- 뒤로 가기 버튼 -->
                 <a th:href="@{/community/courseList}" class="back-button">
                    <i class="fa fa-arrow-left"></i>
                 </a>
                <!-- 강의 정보 -->
                <div class="header" th:if="${course}">
                    <div class="info-box" style="align-items: flex-start;">
                        <div class="course-details" style="display: flex; flex-direction: column;">
                            <div class="name-rating">
                                <h2 th:text="${course.name}">Course</h2>
                                <div class="avg-rating-stars">
                                    <th:block th:with="avgRating=${course.averageRating != null ? T(java.lang.Math).round(course.averageRating) : 0}">
                                        <th:block th:each="i : ${#numbers.sequence(1, 5)}">
                                            <i class="fa fa-star" th:classappend="${i <= avgRating} ? 'filled' : ''"></i>
                                        </th:block>
                                    </th:block>
                                    <span th:text="${course.averageRating != null ? #numbers.formatDecimal(course.averageRating, 1, 1) : '0.0'}">Rating</span>
                                </div>
                            </div>
                            <div style="margin-top: 10px;">
                                <span th:text="${course.instructorName}">Instructor</span>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="review-write-button">レビューを書く<i class="fa fa-pencil"></i></button>
                </div>

                <!-- 리뷰 리스트 -->
                <div class="review-list-container">
                    <div th:if="${#lists.isEmpty(reviews)}">
                        <p>レビューがありません.</p>
                    </div>
                    <div th:unless="${#lists.isEmpty(reviews)}" class="review-cards-grid">
                        <div class="review-card" th:each="review : ${reviews}">
                            <div class="review-rating-start">
                                <th:block th:each="i : ${#numbers.sequence(1, 5)}">
                                    <i class="fa fa-star" th:classappend="${i <= review.rating} ? 'filled' : ''"></i>
                                </th:block>
                            </div>
                            <div class="review-content">
                                <p th:text="${review.commentText}"></p>
                            </div>
                        </div>
                    </div>
                </div>

                <!--모달창-->
                <div id="reviewModal" class="modal-overlay">
                    <div class="modal-content">
                        <button class="close-button">&times;</button>
                        <form id="reviewForm" th:action="@{/community/courseReview/{id}(id=${course.courseId})}" method="post">
                            <h3 class="modal-title">
                                <span th:text="${course.name}">Course</span>  レビュー <i class="fa fa-pencil"></i>
                            </h3>

                            <div class="star-rating-area">
                                <div class="stars">
                                    <i class="fa fa-star" data-value="1"></i>
                                    <i class="fa fa-star" data-value="2"></i>
                                    <i class="fa fa-star" data-value="3"></i>
                                    <i class="fa fa-star" data-value="4"></i>
                                    <i class="fa fa-star" data-value="5"></i>
                                </div>
                                <strong class="rating-value">0</strong>
                                <input type="hidden" name="rating" id="rating" value="0" required>
                            </div>

                            <textarea name="commentText" class="review-textarea" placeholder="レビュー内容を入力してください." required></textarea>

                            <button type="submit" class="submit-button">登録する</button>
                        </form>
                    </div>
                </div>
            </div>
        </section>
        <th:block layout:fragment="script">
            <script th:inline="javascript">
                document.addEventListener('DOMContentLoaded', () => {
                    const openModalBtn = document.querySelector('.review-write-button');
                    const modal = document.getElementById('reviewModal');
                    const closeModalBtn = modal.querySelector('.close-button');
                    const modalOverlay = modal.closest('.modal-overlay');

                    // '리뷰쓰기' 버튼 클릭 시 모달 열기
                    openModalBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        modal.style.display = 'flex';
                    });
                    // 닫기 버튼 클릭 시 모달 닫기
                    closeModalBtn.addEventListener('click', () => {
                        modal.style.display = 'none';
                    });
                    // 모달 바깥 영역 클릭 시 모달 닫기
                    modalOverlay.addEventListener('click', (e) => {
                        if (e.target === modalOverlay) {
                            modal.style.display = 'none';
                        }
                    });

                    /** 별점 기능 **/
                    const stars = modal.querySelectorAll('.stars .fa-star');
                    const ratingValueDisplay = modal.querySelector('.rating-value');
                    const ratingInput = document.getElementById('rating');

                    let currentRating = 0;

                    // 별 클릭 이벤트
                    stars.forEach(star => {
                        star.addEventListener('click', () => {
                            currentRating = star.dataset.value;
                            ratingInput.value = currentRating;
                            ratingValueDisplay.textContent = currentRating;
                            updateStars(currentRating);
                        });
                        // 별 위에 마우스 올렸을 때
                        star.addEventListener('mouseover', () => {
                            updateStars(star.dataset.value, true);
                        });
                    });
                    // 마우스가 별 영역을 떠났을 때
                    modal.querySelector('.stars').addEventListener('mouseout', () => {
                        updateStars(currentRating);
                    });
                    // 별 색상 업데이트
                    function updateStars(rating, isHover = false) {
                        stars.forEach(star => {
                            if (star.dataset.value <= rating) {
                                star.classList.add(isHover ? 'hover' : 'filled');
                                if (!isHover) star.classList.remove('hover');
                            } else {
                                star.classList.remove('filled', 'hover');
                            }
                        });
                    }

                    /** 폼 제출 **/
                    const reviewForm = document.getElementById('reviewForm');
                    reviewForm.addEventListener('submit', function(e) {
                        e.preventDefault();

                        // 평점이 0이면 제출 막기
                        if (parseInt(ratingInput.value) === 0) {
                            alert('評点を選択してください.');
                            return;
                        }

                        const formData = new FormData(this);
                        const actionUrl = this.getAttribute('action');

                        fetch(actionUrl, {
                            method: 'POST',
                            body: new URLSearchParams(formData)
                        })
                        .then(response => {
                            if (response.ok) {
                                alert('レビューが正常に登録されました.');
                                window.location.reload();
                            } else {
                                // 서버에서 보낸 에러 메시지 처리
                                response.text().then(text => {
                                    alert('レビューの登録に失敗しました: ' + text);
                                });
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            alert('エラーが発生しました.');
                        });
                    });
                });
            </script>
        </th:block>
    </body>
</html>