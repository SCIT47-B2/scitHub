<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
    xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{layouts/defaultLayout}">
    <head>
        <title>Home</title>
        <th:block layout:fragment="css">
            <link rel="stylesheet" th:href="@{/css/home.css}">
            <link rel="stylesheet" th:href="@{/css/reservation.css}">
        </th:block>
        <style>
            /* 홈 화면 위젯 컨테이너 */
            .home-schedule-widget {
                max-width: 400px;
                margin: 20px auto;
                padding: 20px;
                background-color: #fff;
                border-radius: 20px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            }

            .widget-header h3 {
                font-size: 1.5em;
                margin-bottom: 15px;
            }

            /* FullCalendar 기본 UI 숨기기 및 수정 */
            #mini-calendar .fc-theme-standard {
                border: none; /* 전체 테두리 제거 */
            }

            #mini-calendar .fc-timegrid-slot-label {
                border: none; /* 시간 축 라인 제거 */
            }

            #mini-calendar .fc-timegrid-col.fc-day-today {
                background-color: transparent; /* 오늘 날짜 배경색 제거 */
            }

            /* 커스텀 이벤트 블록 스타일 */
            #mini-calendar .fc-timegrid-event {
                border-radius: 15px !important; /* 모서리 둥글게 */
                border: none;
                padding: 8px;
                box-shadow: none;
            }

            .custom-event-title {
                font-weight: bold;
                font-size: 1em;
            }

            .custom-event-time {
                font-size: 0.8em;
                opacity: 0.9;
            }

            /* 겹치는 이벤트 사이에 흰색 테두리를 추가하여 시각적으로 분리 */
            #mini-calendar .fc-timegrid-event {
                border: 2px solid white !important;
            }

            /* 종일 이벤트 슬롯의 스타일링 (선택사항) */
            #mini-calendar .fc-daygrid-day-frame {
                padding: 5px;
            }
        </style>
    </head>
    <body>
        <section class="mainGrid" aria-label="메인 영역" layout:fragment="content">

            <!-- 좌: 운영실 + 새로운 질문 (2단 블록) -->
            <div class="leftCol">
                <!-- /** 운영실
                    @desc   파란색 헤더(클릭 → operations.html) + 본문(공지 리스트)
                    @param  없음
                    @return 없음(UI) */ -->
                <section class="stackCard" aria-label="운영실">
                    <a class="sectionHead" href="operations.html">運営室</a>
                    <div class="sectionBody">
                    <ul class="noticeList">
                        <li><a href="notice1.html">09/02(화) 20:00~21:00 네트워크 점검</a></li>
                        <li><a href="notice2.html">09/05(금) 과제 제출 마감</a></li>
                    </ul>
                    </div>
                </section>

                <!-- /** 새로운 질문
                    @desc   파란색 헤더(클릭 → question_submit.html) + 본문(입력창)
                    @param  없음
                    @return 없음(UI) */ -->
                <!-- <section class="stackCard" aria-label="새로운 질문">
                    <a class="sectionHead" href="question_submit.html">新しい質問</a>
                    <div class="sectionBody">
                        <div class="askBox" role="search">
                            <input type="text" id="newQuestionInput" placeholder="回答する" aria-label="답변 입력" />
                            <button class="btn-search" type="button" onclick="location.href='question_submit.html'">登録</button>
                        </div>
                    </div>
                </section> -->
            </div>

            <!-- 중: 검색 → 좌석배치도(비율 유지) -->
            <div class="centerCol">

                <!-- 검색(중앙 컬럼 너비 = 좌석배치도 너비) -->
                <div class="search-row" role="search">
                    <div class="search-input">
                        <i class="fa-solid fa-magnifying-glass" aria-hidden="true"></i>
                        <input type="text" placeholder="検索ワードを入力してください" aria-label="검색어" />
                    </div>
                    <button class="btn-search" aria-label="검색 버튼">検索</button>
                </div>

                <!-- 좌석배치도 -->
                <section class="seatmapCard card" aria-label="좌석배치도 카드">
                    <div class="seatmap" aria-label="강의실 좌석배치도" style="--cols:16; --rows:10;">
                        <!-- 상단 슬림 라벨 바 -->
                        <div class="block labelBar" style="grid-column:3 / span 9; grid-row:1 / span 1;">大講義室</div>
                        <div class="block labelBar" style="grid-column:14 / span 3; grid-row:1 / span 1;">ラウンジ</div>

                        <!-- 세로 복도 3개 -->
                        <div class="corridor" style="grid-column:5  / span 1; grid-row:3 / span 8;"></div>
                        <div class="corridor" style="grid-column:9  / span 1; grid-row:3 / span 8;"></div>
                        <div class="corridor" style="grid-column:13 / span 1; grid-row:3 / span 8;"></div>

                        <!-- 좌측 세로열 -->
                        <a class="block small room" href="#" data-room-id="5" th:data-room-name="${classroomMap.get(5).getClassroomName()}" style="grid-column:1 / span 2; grid-row:3 / span 1; text-decoration:none;" >ルーム5</a>
                        <a class="block small room" href="#" data-room-id="4" th:data-room-name="${classroomMap.get(4).getClassroomName()}" style="grid-column:1 / span 2; grid-row:4 / span 1; text-decoration:none;">ルーム4</a>
                        <a class="block small room" href="#" data-room-id="3" th:data-room-name="${classroomMap.get(3).getClassroomName()}" style="grid-column:1 / span 2; grid-row:5 / span 1; text-decoration:none;">ルーム3</a>
                        <a class="block small room" href="#" data-room-id="2" th:data-room-name="${classroomMap.get(2).getClassroomName()}" style="grid-column:1 / span 2; grid-row:6 / span 1; text-decoration:none;">ルーム2</a>
                        <a class="block small room" href="#" data-room-id="1" th:data-room-name="${classroomMap.get(1).getClassroomName()}" style="grid-column:1 / span 2; grid-row:7 / span 1; text-decoration:none;">ルーム1</a>
                        <div class="block small gray"  style="grid-column:1 / span 2; grid-row:8 / span 1;">倉庫</div>
                        <div class="block small label" style="grid-column:1 / span 2; grid-row:9 / span 1;">面接室2</div>
                        <div class="block small label" style="grid-column:1 / span 2; grid-row:10 / span 1;">面接室1</div>

                        <!-- 좌측 2열 -->
                        <a class="block small room" href="#" data-room-id="10" th:data-room-name="${classroomMap.get(10).getClassroomName()}" style="grid-column:3 / span 2; grid-row:3 / span 1; text-decoration:none;">ルーム10</a>
                        <a class="block small room" href="#" data-room-id="9" th:data-room-name="${classroomMap.get(9).getClassroomName()}" style="grid-column:3 / span 2; grid-row:4 / span 1; text-decoration:none;">ルーム9</a>
                        <a class="block small room" href="#" data-room-id="8" th:data-room-name="${classroomMap.get(8).getClassroomName()}" style="grid-column:3 / span 2; grid-row:5 / span 1; text-decoration:none;">ルーム8</a>
                        <a class="block small room" href="#" data-room-id="7" th:data-room-name="${classroomMap.get(7).getClassroomName()}" style="grid-column:3 / span 2; grid-row:6 / span 1; text-decoration:none;">ルーム7</a>
                        <a class="block small room" href="#" data-room-id="6" th:data-room-name="${classroomMap.get(6).getClassroomName()}" style="grid-column:3 / span 2; grid-row:7 / span 1; text-decoration:none;">ルーム6</a>
                        <div class="block gray" style="grid-column:3 / span 2; grid-row:8 / span 3; font-size:12px;">事務室</div>

                        <!-- 가운데 왼 열 -->
                        <div class="block"       style="grid-column:6 / span 3; grid-row:3 / span 2;">講義室4</div>
                        <div id="lectureRoom3" class="block room reservable clickable-block" style="grid-column:6 / span 3; grid-row:5 / span 2; background:#cfe0ff;">講義室3</div>
                        <div class="block"       style="grid-column:6 / span 3; grid-row:7 / span 2;">講義室2</div>
                        <div class="block"       style="grid-column:6 / span 3; grid-row:9 / span 2;">講義室1</div>

                        <!-- 가운데 오른 열 -->
                        <div class="block" style="grid-column:10 / span 3; grid-row:3 / span 2;">講義室8</div>
                        <div class="block" style="grid-column:10 / span 3; grid-row:5 / span 2;">講義室7</div>
                        <div class="block" style="grid-column:10 / span 3; grid-row:7 / span 2;">講義室6</div>
                        <div class="block" style="grid-column:10 / span 3; grid-row:9 / span 2;">講義室5</div>

                        <!-- 우측 열 (라운드 강조) -->
                        <div class="block reservable clickable-block" style="grid-column:14 / span 3; grid-row:3 / span 2; border-radius:22px; background:#cfe0ff;">講義室12</div>
                        <div class="block reservable clickable-block" style="grid-column:14 / span 3; grid-row:5 / span 2; border-radius:22px; background:#cfe0ff;">講義室11</div>
                        <div class="block"       style="grid-column:14 / span 3; grid-row:7 / span 2; border-radius:22px;">講義室10</div>
                        <div class="block"       style="grid-column:14 / span 3; grid-row:9 / span 2; border-radius:22px;">講義室9</div>
                    </div>
                </section>
            </div>

            <!-- 우: 일정 -->
            <!-- <div class="rightCol">
                <section class="card" aria-label="일정">
                    <h3 class="sectionTitle">日程</h3>
                    <ul class="scheduleList">
                    <li>예시) 09/03(수) 팀 프로젝트 킥오프</li>
                    <li>예시) 09/05(금) 과제 제출 마감</li>
                    </ul>
                </section>
            </div> -->
            <div class="home-schedule-widget">
                <div class="widget-header">
                    <h3 id="widget-date-title"></h3>
                </div>
                <div id="mini-calendar"></div>
            </div>

            <!-- 3강의실 좌석배치도 -->
            <div id="seatModal" class="modal-overlay">
                <div class="modal-content">
                    <button class="close-button" aria-label="닫기">&times;</button>
                    <img th:src="@{/images/seat/roomseat(3).png}" alt="3강의실 좌석배치도 이미지">
                </div>
            </div>

            <!-- 예약 모달 -->
            <div class="reservationModal" id="reservationModal">
                <div class="reservation-modal">
                    <div class="modal-tabs">
                        <h2 class="tab-btn active" id="reservationModalTitle">スタディルーム</h2>
                        <div id="adminControlsContainer" class="admin-controls" style="display: none;"></div>
                    </div>

                    <div class="modal-body">
                    </div>
                </div>
            </div>
        </div>
        </section>
        <th:block layout:fragment="script">
            <!-- FullCalendar CDN -->
            <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.19/index.global.min.js"></script>
            <script th:src="@{/js/reservation.js}"></script>

            <script>
                document.addEventListener('DOMContentLoaded', function() {
                    const calendarEl = document.getElementById('mini-calendar');
                    const titleEl = document.getElementById('widget-date-title');

                    // 캘린더 엘리먼트가 페이지에 존재하는지 확인
                    if (!calendarEl || !titleEl) {
                        console.error("캘린더 위젯을 위한 HTML 엘리먼트(#mini-calendar, #widget-date-title)를 찾을 수 없습니다.");
                        return;
                    }

                    const calendar = new FullCalendar.Calendar(calendarEl, {
                         locale: 'ja', // FullCalendar의 기본 언어를 일본어로 설정
                        // 뷰 설정
                        initialView: 'timeGridDay', // 하루의 시간 그리드 뷰
                        initialDate: new Date(),    // 오늘 날짜로 시작

                        // UI 커스텀
                        headerToolbar: false,     // 기본 헤더(제목, 이전/다음 버튼) 숨기기
                        allDaySlot: true,        // '종일' 슬롯 나타내기
                        height: 'auto',           // 내용에 따라 높이 자동 조절
                        
                        // 시간 축 설정
                        slotMinTime: '08:00:00',  // 캘린더 시작 시간
                        slotMaxTime: '18:00:00',  // 캘린더 종료 시간
                        slotLabelFormat: {        // 시간 축 라벨 형식
                            hour: '2-digit',
                            minute: '2-digit',
                            hour12: false
                        },

                        /**
                         * 이벤트 데이터 로드
                         * - 개인/전체 일정 파라미터를 모두 true로 설정하여 API 호출
                         * - 받아온 데이터에 색상 구분을 적용하여 FullCalendar에 전달
                         */
                        events: function(fetchInfo, successCallback, failureCallback) {
                            fetch('/scitHub/api/calendar/events?showPublic=true&showPrivate=true')
                                .then(response => {
                                    if (!response.ok) {
                                        throw new Error('서버 응답에 실패했습니다.');
                                    }
                                    return response.json();
                                })
                                .then(data => {
                                    // 서버에서 받은 데이터를 FullCalendar 형식에 맞게 가공
                                    const formattedEvents = data.map(event => ({
                                        id: event.eventId,
                                        title: event.title,
                                        start: event.start,
                                        end: event.end,
                                        allDay: event.allDay,
                                        // 색상 구분 로직 적용
                                        color: event.visibility === 'PUBLIC' ? '#ff9f89' : '#3788d8',
                                        extendedProps: {
                                            content: event.content,
                                            visibility: event.visibility,
                                            userId: event.userId
                                        }
                                    }));
                                    successCallback(formattedEvents); // 가공된 데이터를 FullCalendar에 전달
                                })
                                .catch(error => {
                                    console.error('오늘의 일정을 불러오는 데 실패했습니다:', error);
                                    failureCallback(error); // 실패 시 FullCalendar에 에러 전달
                                });
                        },

                        // 이벤트 블록 내부의 HTML을 직접 생성
                        eventContent: function(arg) {
                            const title = arg.event.title;
                            const startTime = arg.event.start.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit', hour12: false });
                            const endTime = arg.event.end ? arg.event.end.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', hour12: false }) : '';

                            return {
                                html: `
                                    <div class="custom-event-title">${title}</div>
                                    <div class="custom-event-time">${startTime} - ${endTime}</div>
                                `
                            };
                        },

                        // 뷰가 렌더링된 후, 위젯 헤더에 오늘 날짜 표시
                        viewDidMount: function(info) {
                            const currentDate = calendar.getDate();
                            titleEl.textContent = currentDate.toLocaleDateString('ja-JP', {
                                year: 'numeric',
                                month: 'long',
                                day: 'numeric',
                                weekday: 'long'
                            });
                        }
                    });

                    calendar.render();
                });

            </script>
        </th:block>
    </body>
</html>